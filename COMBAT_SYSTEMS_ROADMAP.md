# Combat Systems Roadmap
> **Generated by Ralph Loop Analysis - January 2026**

## Executive Summary

After comprehensive multi-agent research, we found that **most combat systems are already wired**. The codebase is more complete than initially thought.

### Status Overview

| System | Status | Notes |
|--------|--------|-------|
| DR/Armor Stopping Power | **COMPLETE** | Full pipeline with 50+ armors |
| Shield Absorption | **COMPLETE** | HP buffer + regen in both engines |
| 68 Weapon Database | **COMPLETE** | Wired this session |
| Equipment Shop | **COMPLETE** | Full buy/sell UI working |
| Free Movement Phase | **COMPLETE** | Fixed 2 bugs this session |
| Small Encounter Maps | **TODO** | Design complete, needs implementation |
| Investigation → Combat | **TODO** | Transition system needed |
| Mace Spray / Special Items | **TODO** | Wire special weapon effects |

---

## 1. WHAT'S ALREADY WORKING

### 1.1 Armor/DR System (FULLY WIRED)
**Files**: `armor.ts`, `armorIntegration.ts`, `CombatScene.ts:5814-5890`

- 50+ armors with DR values (Physical, Energy, Mental)
- Stopping Power blocks low-damage shots completely
- Armor effectiveness modifiers from damage types
- Weapon penetration reduces effective DR
- Cover adds DR bonus

**Flow**:
```
Unit Spawn → getArmorForUnit() → armorData.dr, armorData.stoppingPower
     ↓
Damage Resolution → Stopping Power check → DR reduction → Final damage
```

### 1.2 Shield System (FULLY WIRED)
**Files**: `types.ts:511-520`, `core.ts:564-568`, `CombatScene.ts:5788-5806`

- Shield HP absorbs damage before armor
- Shield regeneration with delay timer
- `bypassesShields` flag on damage types
- Visual shield bar display

**Flow**:
```
Damage Incoming → Shield absorbs first → Reset regen delay
     ↓
Turn Start → Check delay → Regenerate if delay = 0
```

### 1.3 Weapon Database (WIRED THIS SESSION)
**Files**: `weapons.ts`, `weaponIntegration.ts`, `CombatScene.ts:995-1037`

- 68 weapons across 6 categories
- 200+ aliases for flexible lookup
- Range brackets, damage types, stun properties
- Visual effects and sound profiles per weapon

**Flow**:
```
equipment[0] → isValidWeaponKey() → getWeaponData() → lookupWeaponInDatabase()
     ↓
Combat weapon with full stats, visuals, sounds
```

### 1.4 Equipment Shop (ALREADY EXISTS)
**Files**: `shopSystem.ts` (1096 lines), `EquipmentShop.tsx` (529 lines)

- 6 shop types with availability rules
- Location-based pricing (GDP, corruption modifiers)
- Buy/sell with inventory management
- $75,000 starting budget

### 1.5 Free Movement Phase (FIXED THIS SESSION)
**Files**: `types.ts:84-110`, `CombatScene.ts:4811-4833`

- Exploration phase with 0 AP movement cost
- All player units can move freely (no turn order)
- Combat triggers on enemy line of sight
- Switches to turn-based on contact

---

## 2. TODO: Small Encounter System

### 2.1 New Map Size Tiers

Current system only supports 15x15. Add:

```typescript
export type MapSize = 'micro' | 'small' | 'medium' | 'large';

export const MAP_SIZE_SPECS = {
  micro:  { width: 5, height: 5, maxUnits: 2 },   // 1v1 elevator/bathroom
  small:  { width: 6, height: 6, maxUnits: 4 },   // 1v1 or 2v2 apartment
  medium: { width: 8, height: 8, maxUnits: 6 },   // 3v3 safehouse
  large:  { width: 15, height: 15, maxUnits: 12 }, // Current standard
};
```

### 2.2 Small Map Templates

| Map | Size | Description | Use Case |
|-----|------|-------------|----------|
| Apartment | 6x6 | Studio with bed, desk | Investigation gone wrong |
| Alley | 5x7 | Narrow with dumpsters | Street ambush |
| Office | 7x7 | Corner office, desk cover | Corporate confrontation |
| Elevator | 5x5 | No cover, extreme CQB | Nowhere to run |
| Stairwell | 5x8 | Vertical chokepoints | Building infiltration |
| Bathroom | 5x5 | Stalls as cover | Cornered suspect |
| Motel Room | 6x6 | Bed, nightstand | Seedy meetup |
| Interrogation | 6x6 | Table at center | The Box |
| Rooftop | 7x7 | Open, fall hazard at edges | Final showdown |
| Safehouse | 8x8 | Criminal den, 2v2 | Gang raid |

### 2.3 Melee Combat Bonuses

For small maps, apply these modifiers:

```typescript
const SMALL_ENCOUNTER_MODIFIERS = {
  rangedAccuracyPenalty: -20,    // Hard to aim in tight spaces
  rangedAPPenalty: 1,            // +1 AP to fire ranged weapons
  meleeAccuracyBonus: 10,        // Easier to land melee hits
  grappleSuccessBonus: 15,       // Easier to initiate grapples
  wallSlamDamage: 10,            // Knockback into wall hurts
};
```

### 2.4 Implementation Steps

1. **Modify config.ts**: Make `MAP_WIDTH/HEIGHT` read from template
2. **Add templates**: Create 10 small map layouts in `mapTemplates.ts`
3. **Update CombatScene**: Support variable grid dimensions
4. **Add encounter type**: `SmallEncounterConfig` interface
5. **Wire martial arts**: Ensure grapple system works in CombatScene

---

## 3. TODO: Investigation → Combat Transition

### 3.1 Trigger Points

| Phase | Approach | Failure Chance | Map Pool |
|-------|----------|----------------|----------|
| Following Leads | Stealth (blown) | 100% | apartment, alley, stairwell |
| Confrontation | Intimidation | 75% | safehouse, motel, garage |
| Confrontation | Direct | 50% | office, interrogation |
| Resolution | Cornered | 60% | bathroom, elevator |

### 3.2 Transition Flow

```
Investigation Skill Check
         ↓
    FAILURE → Escalation Event
         ↓
    Select Small Map from Pool
         ↓
    Generate 1-2 Enemies
         ↓
    Spawn CombatScene with:
    - isSurpriseRound: true/false
    - encounterScale: 'micro' | 'small'
    - victoryCondition: 'subdue' | 'kill'
```

### 3.3 Implementation Steps

1. **Add combat triggers**: In `investigationSystem.ts`
2. **Create transition handler**: EventBridge event for combat start
3. **Generate contextual enemies**: Martial arts style based on investigation type
4. **Support victory conditions**: Subdue (25% HP or pin) vs Kill

---

## 4. TODO: Special Weapon Effects

### 4.1 Mace Spray (Example)

```typescript
// In weapons.ts - already exists
{
  id: 'SPC_001',
  name: 'Mace Spray',
  damage: 2,
  damageType: 'Chemical - Irritant',
  specialEffect: 'blind',       // Should apply Blind status
  effectDuration: 3,            // 3 turns
  range: 3,                     // Close range only
}
```

**Wiring needed**:
- `applyDamageTypeEffects()` should check for `specialEffect`
- Apply status effect with duration
- Blind status: -50% accuracy, can't use aimed shots

### 4.2 Other Special Weapons

| Weapon | Effect | Status |
|--------|--------|--------|
| Mace Spray | Blind (3 turns) | TODO |
| Taser | Stun (1 turn) | Partial |
| Flashbang | Blind + Deaf (2 turns) | TODO |
| Smoke Grenade | Blocks LOS | Working |
| Stun Rifle | Stun damage | Working |

---

## 5. Files to Modify

### High Priority (Small Encounters)

| File | Changes |
|------|---------|
| `data/mapTemplates.ts` | Add 10 small map layouts |
| `game/config.ts` | Dynamic MAP_WIDTH/HEIGHT |
| `game/scenes/CombatScene.ts` | Variable grid support |
| `data/investigationSystem.ts` | Combat trigger logic |
| `game/EventBridge.ts` | Small encounter events |

### Medium Priority (Special Effects)

| File | Changes |
|------|---------|
| `combat/statusEffects.ts` | Add Blind, Deaf effects |
| `game/scenes/CombatScene.ts` | Wire specialEffect to status |
| `data/weapons.ts` | Add effect properties |

---

## 6. Martial Arts System (Ready to Showcase)

The game has an exceptional martial arts system that small encounters will finally utilize:

**5 Styles**:
- Grappling (STR): Clinch, Takedown, Suplex, Pin
- Submission (MEL): Armbar, Triangle Choke, Rear Naked
- Internal Arts (INS): Deflect, Redirect, Dim Mak
- Counter Fighting (AGL): Intercept, Parry-Riposte, Disarm
- Striking (STR): Jab, Cross, Hook, Knee, Elbow

**Belt Progression**: White → Yellow → Green → Blue → Purple → Brown → Black

**Grapple State Machine**:
```
STANDING ←→ GROUND
    ↓          ↓
 PINNED ←→ SUBMISSION
    ↓
RESTRAINED → CARRIED
```

---

## 7. Session Summary

### Commits Made Today

1. `63b9ba0` - Wire 68-weapon database to CombatScene
2. `62a7c9c` - Enable XCOM2-style free movement in exploration phase

### Discoveries

- Armor/DR: Already fully wired, no work needed
- Shields: Already fully wired, no work needed
- Equipment Shop: Already exists and works
- Free Movement: 70% done, fixed 2 bugs

### Remaining Work

1. **Small Encounter Maps** (~8 hours)
   - Add variable map sizes
   - Create 10 small map templates
   - Wire melee bonuses

2. **Investigation → Combat** (~4 hours)
   - Add trigger points
   - Create transition flow
   - Generate contextual enemies

3. **Special Weapon Effects** (~2 hours)
   - Wire Mace Spray → Blind
   - Wire Flashbang → Blind + Deaf
   - Add effect durations

---

*Document generated by Ralph Loop multi-agent analysis*
*Agents used: ARMOR-DR-RESEARCHER, SHIELD-SYSTEM-RESEARCHER, FREE-MOVEMENT-RESEARCHER, SMALL-ENCOUNTERS-DESIGNER, EQUIPMENT-SHOP-RESEARCHER*
